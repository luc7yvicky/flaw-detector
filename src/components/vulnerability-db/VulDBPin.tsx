"use client";

import { showToast } from "@/components/vulnerability-db/Toast";
import { addPinnedPostToUser, deletePinnedPostFromUser } from "@/lib/api/users";
import { VulDBPinnedInfo } from "@/types/post";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useState } from "react";
import { IconFilledPin, IconPin } from "../ui/Icons";

export default function VulDBPin({
  pinnedInfo,
  isScrapped,
}: {
  pinnedInfo: VulDBPinnedInfo;
  isScrapped: boolean;
}) {
  const [isClicked, setIsClicked] = useState(isScrapped);
  const queryClient = useQueryClient();

  const addPinnedMutation = useMutation({
    mutationFn: async (info: VulDBPinnedInfo) => {
      await addPinnedPostToUser(info);
    },
    onSuccess: () => {
      queryClient.setQueryData(["posts"], (oldPosts: any) => {
        if (!oldPosts) return [];
        return oldPosts.map((post: any) =>
          post.id === pinnedInfo.postId ? { ...post, isScrapped: true } : post,
        );
      });
      showToast("ğŸ“Œ ìŠ¤í¬ë©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤");
      queryClient.invalidateQueries({ queryKey: ["posts"] });
    },
    onError: () => {
      setIsClicked(isScrapped);
      showToast("ğŸš¨ ìŠ¤í¬ë©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    },
  });

  const deletePinnedMutation = useMutation({
    mutationFn: async (info: VulDBPinnedInfo) => {
      await deletePinnedPostFromUser(info);
    },
    onSuccess: () => {
      queryClient.setQueryData(["posts"], (oldPosts: any) => {
        if (!oldPosts) return [];
        return oldPosts.map((post: any) =>
          post.id === pinnedInfo.postId ? { ...post, isScrapped: false } : post,
        );
      });
      showToast("âœ… ìŠ¤í¬ë©ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤");
      queryClient.invalidateQueries({ queryKey: ["posts"] });
    },
    onError: () => {
      setIsClicked(isScrapped);
      showToast("ğŸš¨ ìŠ¤í¬ë© ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    },
  });

  const onClickVulDBPin = (event: React.MouseEvent<HTMLButtonElement>) => {
    event.stopPropagation();
    event.preventDefault();

    if (isScrapped || isClicked) {
      setIsClicked(false);
      deletePinnedMutation.mutate(pinnedInfo);
    } else {
      setIsClicked(true);
      addPinnedMutation.mutate(pinnedInfo);
    }
  };

  return (
    <button onClick={onClickVulDBPin}>
      {isClicked ? (
        <IconFilledPin className="h-[1.625rem] w-[1.625rem]" />
      ) : (
        <IconPin className="h-[1.625rem] w-[1.625rem]" />
      )}
    </button>
  );
}
